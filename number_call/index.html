<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>번호 불러주는 웹 앱</title>
    <!-- Tailwind CSS CDN을 로드하여 스타일링을 쉽게 합니다 -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f0f4f8;
            color: #2d3748;
        }
        select {
            -webkit-appearance: none;
            -moz-appearance: none;
            appearance: none;
            background-image: url('data:image/svg+xml;utf8,<svg fill="black" height="24" viewBox="0 0 24 24" width="24" xmlns="http://www.w3.org/2000/svg"><path d="M7 10l5 5 5-5z"/><path d="M0 0h24v24H0z" fill="none"/></svg>');
            background-repeat: no-repeat;
            background-position-x: 95%;
            background-position-y: center;
        }
    </style>
</head>
<body class="bg-gray-100 min-h-screen flex items-center justify-center p-4">
    <div class="bg-white p-8 rounded-2xl shadow-xl w-full max-w-sm text-center">
        <h1 class="text-3xl font-bold mb-6 text-gray-800">번호 불러주기 & 문장 말하기</h1>
        <p class="text-gray-600 mb-6">음성으로 듣고 싶은 내용을 입력하세요.</p>
        
        <!-- 모드 선택 라디오 버튼 -->
        <div class="flex justify-center items-center gap-4 mb-4">
            <div class="flex items-center">
                <input type="radio" id="mode-number" name="mode-selector" value="number" class="text-blue-600 focus:ring-blue-500" checked>
                <label for="mode-number" class="ml-2 text-sm font-medium text-gray-700">번호 불러주기</label>
            </div>
            <div class="flex items-center">
                <input type="radio" id="mode-sentence" name="mode-selector" value="sentence" class="text-blue-600 focus:ring-blue-500">
                <label for="mode-sentence" class="ml-2 text-sm font-medium text-gray-700">문장 말하기</label>
            </div>
        </div>

        <div class="mb-4">
            <label for="tts-selector" class="block text-sm font-medium text-gray-700 mb-1">음성 생성 방식 선택:</label>
            <select id="tts-selector" class="w-full px-4 py-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 transition-shadow pr-10">
                <option value="gemini">Gemini API (클라우드)</option>
                <option value="web-speech">Web Speech API (내부)</option>
            </select>
        </div>
        <div id="web-speech-options" class="mb-4 hidden">
            <label for="voice-selector" class="block text-sm font-medium text-gray-700 mb-1">목소리 선택 (내부):</label>
            <select id="voice-selector" class="w-full px-4 py-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 transition-shadow pr-10"></select>
        </div>
        <div class="space-y-4">
            <!-- 번호 입력 필드 (초기 상태) -->
            <input
                id="number-input"
                type="text"
                class="w-full px-4 py-2 text-center text-xl font-mono tracking-widest border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 transition-shadow"
                placeholder="1~9999"
            />
            <!-- 문장 입력 필드 (초기 상태는 숨김) -->
            <textarea
                id="sentence-input"
                rows="3"
                class="hidden w-full px-4 py-2 text-base border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 transition-shadow resize-none"
                placeholder="음성으로 말할 문장을 입력하세요."
            ></textarea>
            <button
                id="speak-button"
                class="w-full bg-blue-600 text-white font-semibold py-3 px-6 rounded-xl shadow-lg hover:bg-blue-700 transition-all duration-300 transform hover:scale-105 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-opacity-50 disabled:bg-gray-400 disabled:shadow-none disabled:transform-none"
            >
                번호 불러주기
            </button>
        </div>
        <div id="message-area" class="mt-6 text-sm text-gray-500"></div>
    </div>

    <script>
        // API 키는 이 환경에서 자동으로 제공되므로 빈 문자열로 둡니다.
        const apiKey = "";
        const apiUrl = "https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-tts:generateContent?key=" + apiKey;

        const modeNumberRadio = document.getElementById('mode-number');
        const modeSentenceRadio = document.getElementById('mode-sentence');
        const numberInput = document.getElementById('number-input');
        const sentenceInput = document.getElementById('sentence-input');
        const speakButton = document.getElementById('speak-button');
        const messageArea = document.getElementById('message-area');
        const ttsSelector = document.getElementById('tts-selector');
        const voiceSelector = document.getElementById('voice-selector');
        const webSpeechOptions = document.getElementById('web-speech-options');

        // 숫자를 한글 발음으로 변환하는 함수 (1~4자리)
        function convertToKoreanNumber(numberStr) {
            if (!numberStr || isNaN(numberStr)) {
                return "";
            }

            const numbers = ["", "일", "이", "삼", "사", "오", "육", "칠", "팔", "구"];
            const units = ["", "십", "백", "천"];
            let koreanText = "";
            let length = numberStr.length;

            if (numberStr === "0") {
                return "영";
            }

            for (let i = 0; i < length; i++) {
                const digit = parseInt(numberStr[i]);
                const unit = length - 1 - i;

                if (digit > 0) {
                    if (unit > 0 && digit === 1) {
                        koreanText += units[unit];
                    } else {
                        koreanText += numbers[digit] + units[unit];
                    }
                }
            }
            return koreanText;
        }

        // Base64 문자열을 ArrayBuffer로 변환하는 헬퍼 함수
        function base64ToArrayBuffer(base64) {
            const binaryString = window.atob(base64);
            const len = binaryString.length;
            const bytes = new Uint8Array(len);
            for (let i = 0; i < len; i++) {
                bytes[i] = binaryString.charCodeAt(i);
            }
            return bytes.buffer;
        }

        // PCM 오디오 데이터를 WAV 파일로 변환하는 헬퍼 함수
        function pcmToWav(pcmData, sampleRate) {
            const pcmBuffer = pcmData.buffer;
            const numChannels = 1;
            const bitsPerSample = 16;
            const sampleRateHz = sampleRate;

            const byteRate = numChannels * bitsPerSample / 8 * sampleRateHz;
            const blockAlign = numChannels * bitsPerSample / 8;
            const dataSize = pcmBuffer.byteLength;
            const fileSize = 44 + dataSize;

            const header = new ArrayBuffer(44);
            const view = new DataView(header);

            // RIFF chunk
            view.setUint32(0, 0x52494646, false); // "RIFF"
            view.setUint32(4, fileSize - 8, true);
            view.setUint32(8, 0x57415645, false); // "WAVE"

            // fmt chunk
            view.setUint32(12, 0x666d7420, false); // "fmt "
            view.setUint32(16, 16, true);
            view.setUint16(20, 1, true); // format code
            view.setUint16(22, numChannels, true);
            view.setUint32(24, sampleRateHz, true);
            view.setUint32(28, byteRate, true);
            view.setUint16(32, blockAlign, true);
            view.setUint16(34, bitsPerSample, true);

            // data chunk
            view.setUint32(36, 0x64617461, false); // "data"
            view.setUint32(40, dataSize, true);

            const combined = new Blob([header, pcmBuffer], { type: 'audio/wav' });
            return combined;
        }

        // Gemini API를 이용한 음성 생성 및 재생
        async function generateAndPlayGemini(text) {
            if (!text) {
                messageArea.textContent = '내용을 입력해주세요.';
                return;
            }

            messageArea.textContent = '음성 생성 중... (Gemini API)';
            speakButton.disabled = true;

            try {
                const payload = {
                    contents: [{
                        parts: [{ text: text }]
                    }],
                    generationConfig: {
                        responseModalities: ["AUDIO"],
                        speechConfig: {
                            voiceConfig: {
                                prebuiltVoiceConfig: { voiceName: "Kore" }
                            }
                        }
                    },
                    model: "gemini-2.5-flash-preview-tts"
                };

                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                if (!response.ok) {
                    throw new Error(`HTTP 오류! 상태: ${response.status}`);
                }

                const result = await response.json();
                const part = result?.candidates?.[0]?.content?.parts?.[0];
                const audioData = part?.inlineData?.data;
                const mimeType = part?.inlineData?.mimeType;

                if (audioData && mimeType && mimeType.startsWith("audio/")) {
                    const sampleRate = parseInt(mimeType.match(/rate=(\d+)/)[1], 10);
                    const pcmData = base64ToArrayBuffer(audioData);
                    const pcm16 = new Int16Array(pcmData);
                    const wavBlob = pcmToWav(pcm16, sampleRate);
                    const audioUrl = URL.createObjectURL(wavBlob);

                    const audio = new Audio(audioUrl);
                    audio.play();

                    audio.onended = () => {
                        messageArea.textContent = '';
                    };

                    messageArea.textContent = '음성을 재생합니다...';
                } else {
                    throw new Error("API 응답에 오디오 데이터가 포함되어 있지 않습니다.");
                }

            } catch (error) {
                console.error('오디오 생성/재생 오류:', error);
                messageArea.textContent = `오류 발생: ${error.message}`;
            } finally {
                speakButton.textContent = '번호 불러주기';
                speakButton.disabled = false;
            }
        }

        // Web Speech API를 이용한 음성 생성 및 재생
        function generateAndPlayWebSpeech(text) {
            if (!('speechSynthesis' in window)) {
                messageArea.textContent = '죄송합니다, 이 브라우저는 음성 합성을 지원하지 않습니다.';
                return;
            }

            if (!text) {
                messageArea.textContent = '내용을 입력해주세요.';
                return;
            }

            const utterance = new SpeechSynthesisUtterance(text);
            
            // 사용자가 선택한 목소리 설정
            const selectedVoiceURI = voiceSelector.value;
            const voices = window.speechSynthesis.getVoices();
            const selectedVoice = voices.find(voice => voice.voiceURI === selectedVoiceURI);
            if (selectedVoice) {
                utterance.voice = selectedVoice;
            } else {
                // 기본 한국어 목소리 설정 (선택된 목소리가 없거나 지원되지 않을 경우)
                const koreanVoice = voices.find(voice => voice.lang === 'ko-KR');
                if (koreanVoice) {
                    utterance.voice = koreanVoice;
                }
            }

            utterance.onstart = () => {
                messageArea.textContent = '음성 재생 중... (Web Speech API)';
                speakButton.disabled = true;
            };

            utterance.onend = () => {
                messageArea.textContent = '';
                speakButton.disabled = false;
            };

            utterance.onerror = (event) => {
                messageArea.textContent = `오류 발생: ${event.error}`;
                console.error('Web Speech API 오류:', event.error);
                speakButton.disabled = false;
            };

            window.speechSynthesis.speak(utterance);
        }

        // 사용 가능한 한국어 목소리 목록을 드롭다운에 추가
        function populateVoiceList() {
            if (typeof speechSynthesis === 'undefined') {
                return;
            }
            const voices = speechSynthesis.getVoices();
            voiceSelector.innerHTML = '';
            const koreanVoices = voices.filter(voice => voice.lang.startsWith('ko-'));
            
            if (koreanVoices.length > 0) {
                koreanVoices.forEach(voice => {
                    const option = document.createElement('option');
                    option.textContent = `${voice.name} (${voice.lang})`;
                    option.value = voice.voiceURI;
                    option.setAttribute('data-lang', voice.lang);
                    option.setAttribute('data-name', voice.name);
                    voiceSelector.appendChild(option);
                });
            } else {
                const option = document.createElement('option');
                option.textContent = '사용 가능한 목소리가 없습니다.';
                voiceSelector.appendChild(option);
                voiceSelector.disabled = true;
            }
        }
        
        // 브라우저가 목소리 목록을 로드할 때 이벤트 리스너 등록
        speechSynthesis.addEventListener('voiceschanged', populateVoiceList);
        
        // 페이지 로드 시 즉시 목록 로드 시도
        populateVoiceList();

        // 사용자가 선택한 방식에 따라 적절한 함수를 호출
        function speakNumber() {
            const number = numberInput.value;
            const selectedMethod = ttsSelector.value;
            
            const numberText = convertToKoreanNumber(number);
            const speechText = `${numberText}번 손님 음식 나왔습니다`;
            
            messageArea.textContent = '불러오는 중...';
            speakButton.disabled = true;
            
            if (selectedMethod === 'gemini') {
                generateAndPlayGemini(speechText);
            } else { // 'web-speech'
                generateAndPlayWebSpeech(speechText);
            }
        }
        
        // 사용자가 선택한 방식에 따라 적절한 함수를 호출
        function speakSentence() {
            const sentence = sentenceInput.value;
            const selectedMethod = ttsSelector.value;
            
            messageArea.textContent = '불러오는 중...';
            speakButton.disabled = true;

            if (selectedMethod === 'gemini') {
                generateAndPlayGemini(sentence);
            } else { // 'web-speech'
                generateAndPlayWebSpeech(sentence);
            }
        }

        // 라디오 버튼 변경 이벤트 리스너
        document.querySelectorAll('input[name="mode-selector"]').forEach(radio => {
            radio.addEventListener('change', (event) => {
                if (event.target.value === 'number') {
                    numberInput.classList.remove('hidden');
                    sentenceInput.classList.add('hidden');
                    speakButton.textContent = '번호 불러주기';
                } else {
                    numberInput.classList.add('hidden');
                    sentenceInput.classList.remove('hidden');
                    speakButton.textContent = '문장 말하기';
                }
            });
        });

        // 음성 생성 방식 변경 시 목소리 선택 메뉴 표시/숨김
        ttsSelector.addEventListener('change', (event) => {
            if (event.target.value === 'web-speech') {
                webSpeechOptions.classList.remove('hidden');
            } else {
                webSpeechOptions.classList.add('hidden');
            }
        });

        // 버튼 클릭 이벤트 리스너
        speakButton.addEventListener('click', () => {
            const selectedMode = document.querySelector('input[name="mode-selector"]:checked').value;
            if (selectedMode === 'number') {
                speakNumber();
            } else {
                speakSentence();
            }
        });

        // 엔터 키 입력 시 버튼 클릭
        numberInput.addEventListener('keydown', (event) => {
            if (event.key === 'Enter') {
                event.preventDefault();
                speakNumber();
            }
        });

        sentenceInput.addEventListener('keydown', (event) => {
            if (event.key === 'Enter') {
                event.preventDefault();
                speakSentence();
            }
        });

    </script>
</body>
</html>
